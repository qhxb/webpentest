//获取浏览器所有cookie
function selecookie(){
    chrome.tabs.getSelected(null, function (tab) {    
    chrome.cookies.getAll({
        url:tab.url
        }, function(cookies){
            var coo ='';
            for (var i=0;i<cookies.length;i++){
                console.log(cookies.length);
                coo=coo + cookies[i].name+'='+cookies[i].value+';';
        }

        document.getElementById('pcookie').value=coo;
});
});
}
//重放
function replay(){
    var xhr = new XMLHttpRequest();
    var body = document.getElementById('pcookie').value;
    var post = body.split(/\n\s*\n/g)[1];
    var httpprotocol = document.getElementById('check').checked
    var path = body.split(" ")[1].split(" ")[0];//获取path
    var host = body.split("Host: ")[1].split("\n")[0];//获取host 
    if(httpprotocol==true){var url = 'https://'+host+path}else{var url = 'http://'+host+path}//获取url

    //判断用get请求还是post请求
    if(!post){
        xhr.open("GET", url, true);
        //设置Content-Type
            if(body.toLowerCase().indexOf('content-type')>=0){
                var contenttype = body.toLowerCase().split("content-type:")[1].split("\n")[0].trim();//获取Content-Type
                xhr.setRequestHeader('Content-Type',contenttype);
            }else{xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');}

        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4) {
                var res = document.getElementById('response1').innerText+'\n'+xhr.responseText.length+'--->'+xhr.responseText;
                document.getElementById('response1').innerText = res;
        }
    }
    xhr.send();
    }else{
        xhr.open("POST", url, true);
        //设置Content-Type
            if(body.toLowerCase().indexOf('content-type')>=0){
                var contenttype = body.toLowerCase().split("content-type:")[1].split("\n")[0].trim();//获取Content-Type
                xhr.setRequestHeader('Content-Type',contenttype);
            }else{xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');}

        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4) {
                var res = document.getElementById('response1').innerText+'\n'+xhr.responseText.length+'--->'+xhr.responseText;
                document.getElementById('response1').innerText = res;
                }
    }
    xhr.send(post);
    }
}
//设置cookie
function setcookie(url,name,value){
        chrome.cookies.set({
            'url':url,
            'name':name,
            'value':value
        }, function(cookie){
        });}

//并发测试,请求头设置三个参数cookie、content-type、user-agent
function bfcs(){
    document.getElementById('response1').innerText ='';
    var body = document.getElementById('pcookie').value;
    var post = body.split(/\n\s*\n/g)[1];
    var path = body.split(" ")[1].split(" ")[0];//获取path
    var host = body.split("Host: ")[1].split("\n")[0];//获取host
    var httpprotocol = document.getElementById('check').checked
    if(httpprotocol==true){var url = 'https://'+host+path}else{var url = 'http://'+host+path}//获取url
    //清除cookie
    chrome.cookies.getAll({
        url:url
        }, function(cookies){
            for (var i=0;i<cookies.length;i++){                
                chrome.cookies.remove({
                url:url,
                name: cookies[i].name,   
        }, function(result){
            // console.log(result);
            });
        }
        console.log('clccookie');
});
    var strs= new Array(); //定义一数组,获取cookie数组
    if(body.indexOf('Cookie')>=0){strs=body.split("Cookie:")[1].trim().split("\n")[0].split("; ");} 
    if(body.indexOf('cookie')>=0){strs=body.split("cookie:")[1].trim().split("\n")[0].split("; ");} 
    //循环设置cookie
    for (i=0;i<strs.length ;i++ ) 
        {
        var name = strs[i].split('=')[0]; 
        var value = strs[i].substring(name.length+1);
        setcookie(url,name,value);
        }

    //先判断请求包里是否有user-agnet,如果有发送到background.js。这里有个大坑，就是只有第二次发包才能成功设置到useragent。因为js的单线程异步特性，不会执行完一个指令才执行下一个指令。
    //所以需要把并发循环写在sendMessage的回调函数里，这样就能保证一定设置完了useragent才执行并发循环
    //想想最后决定不设置useragent了
// if(body.toLowerCase().indexOf('user-agent')>=0){
    // var useragent = body.toLowerCase().split("user-agent:")[1].split("\n")[0].trim();//获取User-Agent
    chrome.extension.sendMessage(  {cmd: 'nothing'}, function(response) {  console.log(response); 
    //并发n个request时间
    console.time('bf');
    var bfs = document.getElementById('bfs').value;
    console.log(bfs);
    for (var i=0;i<bfs;i++){
        replay()
    }
    console.timeEnd('bf');
    // }
    });
}

//打开工具包
document.getElementById('gyw').onclick = function open(){
    window.open(chrome.extension.getURL('gongjubao.html'));
}
//点击发送数据包
document.getElementById('replay').onclick = bfcs;


