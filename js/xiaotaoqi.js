//获取浏览器所有cookie
function selecookie(){
    chrome.tabs.getSelected(null, function (tab) {    
    chrome.cookies.getAll({
        url:tab.url
        }, function(cookies){
            var coo ='';
            for (var i=0;i<cookies.length;i++){
                console.log(cookies.length);
                coo=coo + cookies[i].name+'='+cookies[i].value+';';
        }

        document.getElementById('pcookie').value=coo;
});
});
}
//重放
function replay(){
    var xhr = new XMLHttpRequest();
    var body = document.getElementById('pcookie').value;
    var post = body.split(/\n\s*\n/g)[1];
    var httpprotocol = document.getElementById('check').checked
    var path = body.split(" ")[1].split(" ")[0];//获取path
    var host = body.split("Host: ")[1].split("\n")[0];//获取host 
    if(body.indexOf('User-Agent')>=0){
        var useragent = body.split("User-Agent: ")[1].split("\n")[0];//获取User-Agent
    }else{var useragent =''} 
    chrome.extension.sendMessage(  {cmd: useragent}, function(response) {  console.log(response); }  );
    if(httpprotocol==true){var url = 'https://'+host+path}else{var url = 'http://'+host+path}//获取url

    //判断用get请求还是post请求
    if(!post){
        xhr.open("GET", url, true);
        //设置Content-Type
            if(body.indexOf('Content-Type')>=0){
                var contenttype = body.split("Content-Type: ")[1].split("\n")[0];//获取Content-Type
                xhr.setRequestHeader('Content-Type',contenttype);
            }else{xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');}

        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4) {
                var res = document.getElementById('response1').innerText+'\n'+xhr.responseText.length+'--->'+xhr.responseText;
                document.getElementById('response1').innerText = res;
        }
    }
    xhr.send();
    }else{
        xhr.open("POST", url, true);
        //设置Content-Type
            if(body.indexOf('Content-Type')>=0){
                var contenttype = body.split("Content-Type: ")[1].split("\n")[0];//获取Content-Type
                xhr.setRequestHeader('Content-Type',contenttype);
            }else{xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');}

        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4) {
                var res = document.getElementById('response1').innerText+'\n'+xhr.responseText.length+'--->'+xhr.responseText;
                document.getElementById('response1').innerText = res;
                }
    }
    xhr.send(post);
    }
}
//设置cookie
function setcookie(url,name,value){
        chrome.cookies.set({
            'url':url,
            'name':name,
            'value':value
        }, function(cookie){
        });}
//并发测试
function bfcs(){
    document.getElementById('response1').innerText ='';
    var body = document.getElementById('pcookie').value;
    var post = body.split(/\n\s*\n/g)[1];
    var httpprotocol = document.getElementById('check').checked
    var path = body.split(" ")[1].split(" ")[0];//获取path
    var host = body.split("Host: ")[1].split("\n")[0];//获取host
    if(httpprotocol==true){var url = 'https://'+host+path}else{var url = 'http://'+host+path}//获取url
    var strs= new Array(); //定义一数组 
    strs=body.split("Cookie: ")[1].split("\n")[0].split("; "); //获取cookie数组
    //清除cookie
    chrome.cookies.getAll({
        url:url
        }, function(cookies){
            for (var i=0;i<cookies.length;i++){                
                chrome.cookies.remove({
                url:url,
                name: cookies[i].name,   
        }, function(result){
            // console.log(result);
            });
        }
        console.log('clccookie');
});
    //循环设置cookie
    for (i=0;i<strs.length ;i++ ) 
        {
        var name = strs[i].split('=')[0]; 
        var value = strs[i].substring(name.length+1);
        setcookie(url,name,value);
        }
//并发n个request时间
console.time('bf');
var bfs = document.getElementById('bfs').value
console.log(bfs);
for (var i=0;i<bfs;i++){
    replay()
}
console.timeEnd('bf');
}

//打开工具包
document.getElementById('gyw').onclick = function open(){
    window.open(chrome.extension.getURL('gongjubao.html'));
}
//点击发送数据包
document.getElementById('replay').onclick = bfcs;


